name: CI Pipeline

on:
  pull_request:
    branches: [main, master, develop]
  push:
    branches: [main, master, develop]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ========================================
  # 1. Code Quality & Linting
  # ========================================
  lint:
    name: "Lint & Format Check"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          cd auth-service
          pip install ruff

      - name: Ruff Linting
        run: |
          cd auth-service
          ruff check src tests --output-format=github

      - name: Ruff Format Check
        run: |
          cd auth-service
          ruff format --check src tests

  # ========================================
  # 2. Type Checking
  # ========================================
  type-check:
    name: "Type Check (MyPy)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          cd auth-service
          pip install mypy types-redis types-python-jose
          pip install -e .

      - name: MyPy Type Check
        run: |
          cd auth-service
          mypy src --config-file=pyproject.toml

  # ========================================
  # 3. Security Scan
  # ========================================
  security:
    name: "Security Scan"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit Security Check
        run: |
          cd auth-service
          bandit -c pyproject.toml -r src/ -f json -o bandit-report.json || true
          bandit -c pyproject.toml -r src/ -f screen

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: auth-service/bandit-report.json

  # ========================================
  # 4. Unit Tests
  # ========================================
  test-unit:
    name: "Unit Tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          cd auth-service
          pip install -e ".[dev]"

      - name: Run Unit Tests
        run: |
          cd auth-service
          pytest tests/unit/ \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --junitxml=junit.xml \
            -v

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./auth-service/coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: Check Coverage Threshold
        run: |
          cd auth-service
          coverage report --fail-under=80

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            auth-service/junit.xml
            auth-service/htmlcov/

  # ========================================
  # 5. Integration Tests (with services)
  # ========================================
  test-integration:
    name: "Integration Tests"
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: auth_test
          POSTGRES_USER: auth_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          cd auth-service
          pip install -e ".[dev]"

      - name: Run Database Migrations
        env:
          DATABASE_URL: postgresql://auth_user:test_password@localhost:5432/auth_test
        run: |
          cd auth-service
          # Run init.sql and migrations
          PGPASSWORD=test_password psql -h localhost -U auth_user -d auth_test -f scripts/init.sql
          for f in scripts/migrations/*.sql; do
            PGPASSWORD=test_password psql -h localhost -U auth_user -d auth_test -f "$f"
          done

      - name: Run Integration Tests
        env:
          ENV: test
          DATABASE_URL: postgresql://auth_user:test_password@localhost:5432/auth_test?sslmode=disable
          REDIS_URL: redis://localhost:6379/0
          JWT_SECRET_KEY: test-secret-key-for-ci-cd-pipeline-only
        run: |
          cd auth-service
          pytest tests/integration/ \
            --cov=src \
            --cov-append \
            --cov-report=xml \
            -v

  # ========================================
  # 6. Build & Validate
  # ========================================
  build:
    name: "Build Docker Image"
    runs-on: ubuntu-latest
    needs: [lint, type-check, test-unit]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./auth-service
          push: false
          tags: auth-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: auth-service:${{ github.sha }}
          format: sarif
          output: trivy-results.sarif

      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif

  # ========================================
  # 7. Status Check (Required for PR merge)
  # ========================================
  ci-success:
    name: "CI Pipeline Success"
    runs-on: ubuntu-latest
    needs: [lint, type-check, security, test-unit, test-integration, build]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.type-check.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ] || \
             [ "${{ needs.test-unit.result }}" != "success" ] || \
             [ "${{ needs.test-integration.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "❌ One or more CI jobs failed"
            exit 1
          fi
          echo "✅ All CI jobs passed!"
